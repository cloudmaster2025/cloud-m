name: Multi-Cloud VM Start Stop

on:
  workflow_dispatch:
    inputs:
      cloud:
        description: "Target cloud (aws | azure | gcp)"
        required: true
        default: "aws"

      vm:
        description: "Target VM (vm1 | vm2 | vm3)"
        required: true
        default: "vm1"

      action:
        description: "Action to perform (start | stop)"
        required: true
        default: "stop"

jobs:
  vm-control:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Cloud Custodian
        run: |
          python -m pip install --upgrade pip
          pip install c7n

      # ---------------- AWS AUTH ----------------
      - name: Configure AWS credentials
        if: ${{ inputs.cloud == 'aws' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # ---------------- AZURE AUTH ----------------
      - name: Azure Login
        if: ${{ inputs.cloud == 'azure' }}
        uses: azure/login@v2
        with:
          auth-type: SERVICE_PRINCIPAL
          creds: |
           {
             "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
             "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
             "tenantId": "${{ secrets.AZURE_TENANT_ID }}",
             "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
           }

      # ---------------- GCP AUTH ----------------
      - name: GCP Authentication
        if: ${{ inputs.cloud == 'gcp' }}
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # ---------------- RUN CLOUD CUSTODIAN ----------------
      - name: Run Cloud Custodian policy
        run: |
          POLICY="policies/${{ inputs.cloud }}-${{ inputs.action }}.yml"
          POLICY_PROCESSED="policies/${{ inputs.cloud }}-${{ inputs.action }}-processed.yml"
          OUTPUT_DIR="output/${{ inputs.cloud }}-${{ inputs.action }}-${{ inputs.vm }}"
    
          echo "Running for VM=${{ inputs.vm }}"
          export VM=${{ inputs.vm }}
    
          # Substitute environment variables in the policy file
          envsubst < $POLICY > $POLICY_PROCESSED
    
          # Run custodian with the processed policy
          custodian run -s $OUTPUT_DIR $POLICY_PROCESSED





